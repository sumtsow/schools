<?php
$title = $school->name;
$this->headTitle($title);
?>
<?= ($this->headScript()->prependFile("/js/smile.js")); ?>
<table class="table">
    <tbody>
        <tr>
            <th><img style="max-width: 100px;" src="<?= $school->logo ?>" alt="logo" /></th>
            <td class="align-middle"><h2><?= $title; ?></h2></td>	
        </tr>        
        <tr>
            <th>Адрес</th>
            <td><?= $school->address; ?></td>	
        </tr>
        <tr>	
            <th>Телефон</th>
            <td><?= $school->phone; ?></td>
        </tr>	
        <tr>		
            <th>E-mail</th>	
            <td><a target="_blank" href="mailto://<?= $school->email;?>"><?= $school->email;?></a></td>
        </tr>	
        <tr>		
            <th>WWW</th>
            <td><a target="_blank" href="<?= $school->http;?>"><?= parse_url($school->http, PHP_URL_HOST);?></a></td>	
        </tr>
<?php if($school->info) : ?>
        <tr>	
            <th>Информация</th>
            <td><?= $school->info; ?></td>	
        </tr>
<?php endif; ?>
        <tr>	
            <th>Район</th>
            <td><?= $school->area; ?></td>
        </tr>	
        <tr>	
            <th>Карта</th>
            <td><?= $school->map; ?></td>	
        </tr>
    </tbody>
</table>
<h3>Отзывы пользователей</h3>
<div class="row"><!-- Existing comments -->
    <div class="col-md-12">
<?php
foreach ($comments as $comment) :
    $text = $comment->insertSmile();
    if(isset($username)) :
?>
        <div class="card border border-secondary my-3">
            <div class="card-header">
<?php
// Form for Comment Deletion
$form = $this->form;
$form->setAttribute('action', $this->url(
    'admin',
    [
        'action' => 'delcomment',
        'id'     => $comment->id,
        'area' => null,
        'page' => null,    
    ]))
    ->setAttribute('class', 'd-inline-flex')
    ->setAttribute('name', 'delcomment')
    ->setAttribute('id', 'delcomment')    ;

$form->bind($comment);
$form->get('id')->setValue($comment->id);
$form->prepare(); ?>
<?= $this->form()->openTag($form); ?>
<?= $this->formSubmit($form->get('delComment')
        ->setAttribute('class', 'btn btn-light font-weight-bold px-2 py-1')
        ->setAttribute('value', 'X')); ?>
<?= $this->form()->closeTag(); ?>
        
            
<?php
// Form for $comment->visible switch on/off
$form->setAttribute('action', $this->url(
    'schools',
    [
        'action' => 'view',
        'id'     => $school->id,
        'area' => null,
        'page' => null,  
    ]))
    ->setAttribute('class', 'd-inline-flex p-2 mr-3')
    ->setAttribute('name', 'disComment')
    ->setAttribute('id','disComment');
$form->get('visible')
    ->setAttribute('onchange', 'this.form.submit();')
    ->setAttribute('title', 'Виден пользователям');
$form->bind($comment);
$form->get('id')->setValue($comment->id);
$form->prepare();
?>
<?= $this->form()->openTag($form); ?>
<?= $this->formHidden($form->get('id')); ?>
<?= $this->formCheckbox($form->get('visible')); ?>
<?= $this->form()->closeTag(); ?>
<?php $text = $comment->censorComment($text); ?>
<?= $comment->author;?> | <?= (strftime('%d %b %Y %X ',$comment->time));?>
            </div>
            <div class="card-body"><?= $text; ?></div>
        </div>
<?php
    else :
        if($comment->visible) :
            $text = $comment->censorComment($text);?>
        <div class="card border border-secondary my-3">
            <div class="card-header">
<?= $comment->author;?> | <?= (strftime('%d %b %Y %X ', $comment->time));?>
            </div>
            <div class="card-body"><?=  $text; ?></div>
        </div>
<?php
        endif;
    endif;
endforeach;   
?>
    </div>
</div><!-- Existing comments END -->
<div class="row bg-dark text-light pt-5"><!-- New comment -->
    <div class="col-md-12">
        <h4>Добавить отзыв</h4>
<?php
$form = $this->form;
$form->setAttribute('action', $this->url(
    'schools',
    array(
        'action' => 'view',
        'id'     => $school->id,
        'area' => null,
        'page' => null,  
    )
));
$form->setAttribute('class', 'd-block')
    ->setAttribute('name', 'comment')
    ->setAttribute('id', 'comment')
    ->prepare();
$form->get('id')->setValue(0);
$form->get('text')->setValue('');
?>
<?= $this->form()->openTag($form); ?>
        <div class="form-group">
<?= $this->formHidden($form->get('id')); ?>
<?php if(isset($username)) :
    $form->get('author')->setValue('Администратор');
endif; ?>
<?= $this->formRow($form->get('author')->setAttribute('class', 'form-control')); ?>
            <div class="nav bg-dark text-light border-0 nav-tabs"><div class="nav-link active py-0"><?php include($docRoot.'/smile.html'); ?></div></div>
<?= $this->formRow($form->get('text')->setAttribute('class', 'form-control p-2 mt-0 rounded-0')->setAttribute('style', 'height: 10rem;')); ?>
<br />
<?php $form->get('submit')
        ->setAttribute('title', 'Сохранить')
        ->setAttribute('id', 'submitbutton')
        ->setAttribute('class', 'btn btn-primary mb-3')
        ->setValue('Сохранить'); ?>
<?= $this->formSubmit($form->get('submit')); ?>
        </div>
<?= $this->form()->closeTag(); ?>
    </div>
</div><!-- New comment END -->
